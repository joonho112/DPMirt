<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<title>Under the Hood: NIMBLE Backend and Advanced Usage • DPMirt</title>
<script src="../deps/jquery-3.6.0/jquery-3.6.0.min.js"></script><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<link href="../deps/bootstrap-5.3.1/bootstrap.min.css" rel="stylesheet">
<script src="../deps/bootstrap-5.3.1/bootstrap.bundle.min.js"></script><link href="../deps/font-awesome-6.5.2/css/all.min.css" rel="stylesheet">
<link href="../deps/font-awesome-6.5.2/css/v4-shims.min.css" rel="stylesheet">
<script src="../deps/headroom-0.11.0/headroom.min.js"></script><script src="../deps/headroom-0.11.0/jQuery.headroom.min.js"></script><script src="../deps/bootstrap-toc-1.0.1/bootstrap-toc.min.js"></script><script src="../deps/clipboard.js-2.0.11/clipboard.min.js"></script><script src="../deps/search-1.0.0/autocomplete.jquery.min.js"></script><script src="../deps/search-1.0.0/fuse.min.js"></script><script src="../deps/search-1.0.0/mark.min.js"></script><!-- pkgdown --><script src="../pkgdown.js"></script><meta property="og:title" content="Under the Hood: NIMBLE Backend and Advanced Usage">
<meta name="description" content="A deep dive into DPMirt's NIMBLE implementation --- programmatic code generation, custom samplers and distributions, the compile-once sample-many architecture, post-hoc rescaling, and DP density reconstruction --- for users who want to understand or extend the package internals.
">
<meta property="og:description" content="A deep dive into DPMirt's NIMBLE implementation --- programmatic code generation, custom samplers and distributions, the compile-once sample-many architecture, post-hoc rescaling, and DP density reconstruction --- for users who want to understand or extend the package internals.
">
</head>
<body>
    <a href="#main" class="visually-hidden-focusable">Skip to contents</a>


    <nav class="navbar navbar-expand-lg fixed-top bg-primary" data-bs-theme="dark" aria-label="Site navigation"><div class="container">

    <a class="navbar-brand me-2" href="../index.html">DPMirt</a>

    <small class="nav-text text-muted me-auto" data-bs-toggle="tooltip" data-bs-placement="bottom" title="">0.1.0</small>


    <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbar" aria-controls="navbar" aria-expanded="false" aria-label="Toggle navigation">
      <span class="navbar-toggler-icon"></span>
    </button>

    <div id="navbar" class="collapse navbar-collapse ms-3">
      <ul class="navbar-nav me-auto">
<li class="nav-item"><a class="nav-link" href="../reference/index.html">Reference</a></li>
<li class="active nav-item dropdown">
  <button class="nav-link dropdown-toggle" type="button" id="dropdown-vignettes" data-bs-toggle="dropdown" aria-expanded="false" aria-haspopup="true">Vignettes</button>
  <ul class="dropdown-menu" aria-labelledby="dropdown-vignettes">
<li><h6 class="dropdown-header" data-toc-skip>--- Getting Started ---</h6></li>
    <li><a class="dropdown-item" href="../articles/introduction.html">Introduction</a></li>
    <li><a class="dropdown-item" href="../articles/quick-start.html">Quick Start</a></li>
    <li><a class="dropdown-item" href="../articles/models-and-workflow.html">Models &amp; Workflow</a></li>
    <li><h6 class="dropdown-header" data-toc-skip>--- Theory &amp; Methods ---</h6></li>
    <li><a class="dropdown-item" href="../articles/theory-irt-dpm.html">IRT &amp; DPM Theory</a></li>
    <li><a class="dropdown-item" href="../articles/posterior-summaries.html">Posterior Summaries</a></li>
    <li><a class="dropdown-item" href="../articles/prior-elicitation.html">Prior Elicitation</a></li>
    <li><h6 class="dropdown-header" data-toc-skip>--- Advanced ---</h6></li>
    <li><a class="dropdown-item" href="../articles/nimble-internals.html">NIMBLE Internals</a></li>
    <li><a class="dropdown-item" href="../articles/simulation-study.html">Simulation Study</a></li>
  </ul>
</li>
<li class="nav-item"><a class="nav-link" href="../news/index.html">Changelog</a></li>
      </ul>
<ul class="navbar-nav">
<li class="nav-item"><form class="form-inline" role="search">
 <input class="form-control" type="search" name="search-input" id="search-input" autocomplete="off" aria-label="Search site" placeholder="Search for" data-search-index="../search.json">
</form></li>
<li class="nav-item"><a class="external-link nav-link" href="https://github.com/joonho112/DPMirt/" aria-label="GitHub"><span class="fa fab fa-github fa-lg"></span></a></li>
      </ul>
</div>


  </div>
</nav><div class="container template-article">




<div class="row">
  <main id="main" class="col-md-9"><div class="page-header">

      <h1>Under the Hood: NIMBLE Backend and Advanced Usage</h1>
                        <h4 data-toc-skip class="author">JoonHo Lee</h4>
            
            <h4 data-toc-skip class="date">2026-02-11</h4>
      
      <small class="dont-index">Source: <a href="https://github.com/joonho112/DPMirt/blob/HEAD/vignettes/nimble-internals.Rmd" class="external-link"><code>vignettes/nimble-internals.Rmd</code></a></small>
      <div class="d-none name"><code>nimble-internals.Rmd</code></div>
    </div>

    
    
<div class="section level2">
<h2 id="overview">Overview<a class="anchor" aria-label="anchor" href="#overview"></a>
</h2>
<p>DPMirt is built on top of the NIMBLE probabilistic programming
framework (de Valpine et al., 2017). This vignette is for users who want
to:</p>
<ul>
<li>Understand <strong>how</strong> DPMirt generates NIMBLE model
code.</li>
<li>Inspect and modify the <strong>custom NIMBLE components</strong>
(distributions and samplers).</li>
<li>Leverage the <strong>compile-once, sample-many</strong> pattern for
efficient multi-chain or exploratory workflows.</li>
<li>Understand the <strong>post-hoc rescaling</strong> that resolves
identification indeterminacy.</li>
<li>Reconstruct the <strong>DP mixture density</strong> from posterior
samples.</li>
</ul>
<p>Most users will never need this level of detail — the
<code><a href="../reference/dpmirt.html">dpmirt()</a></code> function handles everything automatically. But if
you want to write custom samplers, hook into the compiled MCMC, or adapt
DPMirt for a new model, this is where to start.</p>
</div>
<div class="section level2">
<h2 id="programmatic-code-generation">Programmatic Code Generation<a class="anchor" aria-label="anchor" href="#programmatic-code-generation"></a>
</h2>
<div class="section level3">
<h3 id="why-programmatic">Why Programmatic?<a class="anchor" aria-label="anchor" href="#why-programmatic"></a>
</h3>
<p>Paganin et al. (2023) provide over 20 separate NIMBLE code files, one
for each model–prior–identification combination. DPMirt instead
generates NIMBLE code programmatically via <code><a href="../reference/dpmirt_spec.html">dpmirt_spec()</a></code>,
dispatching on three configuration axes:</p>
<table class="table">
<colgroup>
<col width="40%">
<col width="60%">
</colgroup>
<thead><tr class="header">
<th align="left">Axis</th>
<th align="left">Options</th>
</tr></thead>
<tbody>
<tr class="odd">
<td align="left">Model</td>
<td align="left">rasch, 2pl, 3pl</td>
</tr>
<tr class="even">
<td align="left">Prior</td>
<td align="left">normal, dpm</td>
</tr>
<tr class="odd">
<td align="left">Identification</td>
<td align="left">constrained_item, constrained_ability,
unconstrained</td>
</tr>
</tbody>
</table>
<p>This yields
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mn>3</mn><mo>×</mo><mn>2</mn><mo>×</mo><mn>3</mn><mo>=</mo><mn>18</mn></mrow><annotation encoding="application/x-tex">3 \times 2 \times 3 = 18</annotation></semantics></math>
potential combinations (not all valid), all generated from a single
specification call.</p>
</div>
<div class="section level3">
<h3 id="inspecting-a-specification">Inspecting a Specification<a class="anchor" aria-label="anchor" href="#inspecting-a-specification"></a>
</h3>
<p>The <code><a href="../reference/dpmirt_spec.html">dpmirt_spec()</a></code> function is lightweight — it builds
the NIMBLE code, constants, data, initial values, and monitor
configuration without compiling anything. This is fast (under 1 second)
and produces a fully inspectable object:</p>
<div class="sourceCode" id="cb1"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Generate some example data</span></span>
<span><span class="va">sim</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/dpmirt_simulate.html">dpmirt_simulate</a></span><span class="op">(</span><span class="fl">200</span>, <span class="fl">25</span>, model <span class="op">=</span> <span class="st">"rasch"</span>, latent_shape <span class="op">=</span> <span class="st">"bimodal"</span>,</span>
<span>                       seed <span class="op">=</span> <span class="fl">42</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Create a specification (no compilation)</span></span>
<span><span class="va">spec</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/dpmirt_spec.html">dpmirt_spec</a></span><span class="op">(</span></span>
<span>  <span class="va">sim</span><span class="op">$</span><span class="va">response</span>,</span>
<span>  model  <span class="op">=</span> <span class="st">"rasch"</span>,</span>
<span>  prior  <span class="op">=</span> <span class="st">"dpm"</span>,</span>
<span>  alpha_prior <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span>a <span class="op">=</span> <span class="fl">1</span>, b <span class="op">=</span> <span class="fl">3</span><span class="op">)</span>,</span>
<span>  base_measure <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span>s2_mu <span class="op">=</span> <span class="fl">2</span>, nu1 <span class="op">=</span> <span class="fl">2.01</span>, nu2 <span class="op">=</span> <span class="fl">1.01</span><span class="op">)</span></span>
<span><span class="op">)</span></span>
<span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/print.html" class="external-link">print</a></span><span class="op">(</span><span class="va">spec</span><span class="op">)</span></span>
<span><span class="co">#&gt; DPMirt Model Specification</span></span>
<span><span class="co">#&gt; ==========================</span></span>
<span><span class="co">#&gt; Model:            RASCH </span></span>
<span><span class="co">#&gt; Prior:            dpm </span></span>
<span><span class="co">#&gt; Identification:   constrained_item </span></span>
<span><span class="co">#&gt; Persons (N):      200 </span></span>
<span><span class="co">#&gt; Items (I):        25 </span></span>
<span><span class="co">#&gt; Max clusters (M): 50 </span></span>
<span><span class="co">#&gt; Alpha prior:      Gamma(1, 3)</span></span>
<span><span class="co">#&gt; Monitors:         beta, alpha, zi, muTilde, s2Tilde, myLogProbAll, myLogProbSome, myLogLik </span></span>
<span><span class="co">#&gt; Monitors2:        eta</span></span></code></pre></div>
</div>
<div class="section level3">
<h3 id="inspecting-the-generated-code">Inspecting the Generated Code<a class="anchor" aria-label="anchor" href="#inspecting-the-generated-code"></a>
</h3>
<p>The <code>code</code> element is a <code>nimbleCode</code> object
that you can print or manipulate:</p>
<div class="sourceCode" id="cb2"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">spec</span><span class="op">$</span><span class="va">code</span></span>
<span><span class="co">#&gt; {</span></span>
<span><span class="co">#&gt;     for (j in 1:N) {</span></span>
<span><span class="co">#&gt;         for (i in 1:I) {</span></span>
<span><span class="co">#&gt;             y[j, i] ~ dbern(pi[j, i])</span></span>
<span><span class="co">#&gt;             logit(pi[j, i]) &lt;- eta[j] - beta[i]</span></span>
<span><span class="co">#&gt;         }</span></span>
<span><span class="co">#&gt;     }</span></span>
<span><span class="co">#&gt;     for (i in 1:I) {</span></span>
<span><span class="co">#&gt;         beta.tmp[i] ~ dnorm(0, var = sigma2_beta)</span></span>
<span><span class="co">#&gt;     }</span></span>
<span><span class="co">#&gt;     beta[1:I] &lt;- beta.tmp[1:I] - mean(beta.tmp[1:I])</span></span>
<span><span class="co">#&gt;     zi[1:N] ~ dCRP(alpha, size = N)</span></span>
<span><span class="co">#&gt;     alpha ~ dgamma(a, b)</span></span>
<span><span class="co">#&gt;     for (j in 1:N) {</span></span>
<span><span class="co">#&gt;         eta[j] ~ dnorm(mu_j[j], var = s2_j[j])</span></span>
<span><span class="co">#&gt;         mu_j[j] &lt;- muTilde[zi[j]]</span></span>
<span><span class="co">#&gt;         s2_j[j] &lt;- s2Tilde[zi[j]]</span></span>
<span><span class="co">#&gt;     }</span></span>
<span><span class="co">#&gt;     for (m in 1:M) {</span></span>
<span><span class="co">#&gt;         muTilde[m] ~ dnorm(0, var = s2_mu)</span></span>
<span><span class="co">#&gt;         s2Tilde[m] ~ dinvgamma(nu1, nu2)</span></span>
<span><span class="co">#&gt;     }</span></span>
<span><span class="co">#&gt;     myLogProbAll ~ dnorm(0, 1)</span></span>
<span><span class="co">#&gt;     myLogProbSome ~ dnorm(0, 1)</span></span>
<span><span class="co">#&gt;     myLogLik ~ dnorm(0, 1)</span></span>
<span><span class="co">#&gt; }</span></span></code></pre></div>
</div>
<div class="section level3">
<h3 id="inspecting-constants-and-monitors">Inspecting Constants and Monitors<a class="anchor" aria-label="anchor" href="#inspecting-constants-and-monitors"></a>
</h3>
<div class="sourceCode" id="cb3"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Constants passed to the NIMBLE model</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/utils/str.html" class="external-link">str</a></span><span class="op">(</span><span class="va">spec</span><span class="op">$</span><span class="va">constants</span><span class="op">)</span></span>
<span><span class="co">#&gt; List of 9</span></span>
<span><span class="co">#&gt;  $ N          : int 200</span></span>
<span><span class="co">#&gt;  $ I          : int 25</span></span>
<span><span class="co">#&gt;  $ sigma2_beta: num 3</span></span>
<span><span class="co">#&gt;  $ M          : int 50</span></span>
<span><span class="co">#&gt;  $ a          : Named num 1</span></span>
<span><span class="co">#&gt;   ..- attr(*, "names")= chr "a"</span></span>
<span><span class="co">#&gt;  $ b          : Named num 3</span></span>
<span><span class="co">#&gt;   ..- attr(*, "names")= chr "b"</span></span>
<span><span class="co">#&gt;  $ s2_mu      : num 2</span></span>
<span><span class="co">#&gt;  $ nu1        : num 2.01</span></span>
<span><span class="co">#&gt;  $ nu2        : num 1.01</span></span></code></pre></div>
<div class="sourceCode" id="cb4"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># What gets tracked during MCMC</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/cat.html" class="external-link">cat</a></span><span class="op">(</span><span class="st">"Primary monitors:"</span>, <span class="fu"><a href="https://rdrr.io/r/base/paste.html" class="external-link">paste</a></span><span class="op">(</span><span class="va">spec</span><span class="op">$</span><span class="va">monitors</span>, collapse <span class="op">=</span> <span class="st">", "</span><span class="op">)</span>, <span class="st">"\n"</span><span class="op">)</span></span>
<span><span class="co">#&gt; Primary monitors: beta, alpha, zi, muTilde, s2Tilde, myLogProbAll, myLogProbSome, myLogLik</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/cat.html" class="external-link">cat</a></span><span class="op">(</span><span class="st">"Thinned monitors:"</span>, <span class="fu"><a href="https://rdrr.io/r/base/paste.html" class="external-link">paste</a></span><span class="op">(</span><span class="va">spec</span><span class="op">$</span><span class="va">monitors2</span>, collapse <span class="op">=</span> <span class="st">", "</span><span class="op">)</span>, <span class="st">"\n"</span><span class="op">)</span></span>
<span><span class="co">#&gt; Thinned monitors: eta</span></span></code></pre></div>
</div>
<div class="section level3">
<h3 id="annotated-walkthrough-rasch-dpm-unconstrained">Annotated Walkthrough: Rasch-DPM-Unconstrained<a class="anchor" aria-label="anchor" href="#annotated-walkthrough-rasch-dpm-unconstrained"></a>
</h3>
<p>The generated code for a Rasch model with DPM prior and unconstrained
identification has this structure (shown here as pseudocode for
clarity):</p>
<pre><code><span><span class="fu"><a href="https://rdrr.io/pkg/nimble/man/nimbleCode.html" class="external-link">nimbleCode</a></span><span class="op">(</span><span class="op">{</span></span>
<span>  <span class="co"># --- Likelihood ---</span></span>
<span>  <span class="kw">for</span> <span class="op">(</span><span class="va">i</span> <span class="kw">in</span> <span class="fl">1</span><span class="op">:</span><span class="va">I</span><span class="op">)</span> <span class="op">{</span></span>
<span>    <span class="kw">for</span> <span class="op">(</span><span class="va">j</span> <span class="kw">in</span> <span class="fl">1</span><span class="op">:</span><span class="va">N</span><span class="op">)</span> <span class="op">{</span></span>
<span>      <span class="va">y</span><span class="op">[</span><span class="va">j</span>, <span class="va">i</span><span class="op">]</span> <span class="op">~</span> <span class="fu">dbern</span><span class="op">(</span><span class="va">pi</span><span class="op">[</span><span class="va">j</span>, <span class="va">i</span><span class="op">]</span><span class="op">)</span></span>
<span>      <span class="fu"><a href="https://rdrr.io/pkg/nimble/man/nimble-math.html" class="external-link">logit</a></span><span class="op">(</span><span class="va">pi</span><span class="op">[</span><span class="va">j</span>, <span class="va">i</span><span class="op">]</span><span class="op">)</span> <span class="op">&lt;-</span> <span class="va">eta</span><span class="op">[</span><span class="va">j</span><span class="op">]</span> <span class="op">-</span> <span class="va">beta</span><span class="op">[</span><span class="va">i</span><span class="op">]</span>      <span class="co"># Rasch ICC</span></span>
<span>    <span class="op">}</span></span>
<span>  <span class="op">}</span></span>
<span></span>
<span>  <span class="co"># --- Item parameters: free (rescaled post-hoc) ---</span></span>
<span>  <span class="kw">for</span> <span class="op">(</span><span class="va">i</span> <span class="kw">in</span> <span class="fl">1</span><span class="op">:</span><span class="va">I</span><span class="op">)</span> <span class="op">{</span></span>
<span>    <span class="va">beta</span><span class="op">[</span><span class="va">i</span><span class="op">]</span> <span class="op">~</span> <span class="fu"><a href="https://rdrr.io/r/stats/Normal.html" class="external-link">dnorm</a></span><span class="op">(</span><span class="fl">0</span>, var <span class="op">=</span> <span class="va">sigma2_beta</span><span class="op">)</span>        <span class="co"># Prior on difficulties</span></span>
<span>  <span class="op">}</span></span>
<span></span>
<span>  <span class="co"># --- DPM prior for abilities via CRP ---</span></span>
<span>  <span class="va">zi</span><span class="op">[</span><span class="fl">1</span><span class="op">:</span><span class="va">N</span><span class="op">]</span> <span class="op">~</span> <span class="fu"><a href="https://rdrr.io/pkg/nimble/man/ChineseRestaurantProcess.html" class="external-link">dCRP</a></span><span class="op">(</span><span class="va">alpha</span>, size <span class="op">=</span> <span class="va">N</span><span class="op">)</span>                <span class="co"># Cluster assignments</span></span>
<span>  <span class="va">alpha</span> <span class="op">~</span> <span class="fu"><a href="https://rdrr.io/r/stats/GammaDist.html" class="external-link">dgamma</a></span><span class="op">(</span><span class="va">a</span>, <span class="va">b</span><span class="op">)</span>                           <span class="co"># Concentration parameter</span></span>
<span></span>
<span>  <span class="kw">for</span> <span class="op">(</span><span class="va">j</span> <span class="kw">in</span> <span class="fl">1</span><span class="op">:</span><span class="va">N</span><span class="op">)</span> <span class="op">{</span></span>
<span>    <span class="va">eta</span><span class="op">[</span><span class="va">j</span><span class="op">]</span> <span class="op">~</span> <span class="fu"><a href="https://rdrr.io/r/stats/Normal.html" class="external-link">dnorm</a></span><span class="op">(</span><span class="va">mu_j</span><span class="op">[</span><span class="va">j</span><span class="op">]</span>, var <span class="op">=</span> <span class="va">s2_j</span><span class="op">[</span><span class="va">j</span><span class="op">]</span><span class="op">)</span>      <span class="co"># Person ability</span></span>
<span>    <span class="va">mu_j</span><span class="op">[</span><span class="va">j</span><span class="op">]</span>  <span class="op">&lt;-</span> <span class="va">muTilde</span><span class="op">[</span><span class="va">zi</span><span class="op">[</span><span class="va">j</span><span class="op">]</span><span class="op">]</span>                   <span class="co"># Cluster mean</span></span>
<span>    <span class="va">s2_j</span><span class="op">[</span><span class="va">j</span><span class="op">]</span>  <span class="op">&lt;-</span> <span class="va">s2Tilde</span><span class="op">[</span><span class="va">zi</span><span class="op">[</span><span class="va">j</span><span class="op">]</span><span class="op">]</span>                   <span class="co"># Cluster variance</span></span>
<span>  <span class="op">}</span></span>
<span></span>
<span>  <span class="kw">for</span> <span class="op">(</span><span class="va">m</span> <span class="kw">in</span> <span class="fl">1</span><span class="op">:</span><span class="va">M</span><span class="op">)</span> <span class="op">{</span></span>
<span>    <span class="va">muTilde</span><span class="op">[</span><span class="va">m</span><span class="op">]</span>  <span class="op">~</span> <span class="fu"><a href="https://rdrr.io/r/stats/Normal.html" class="external-link">dnorm</a></span><span class="op">(</span><span class="fl">0</span>, var <span class="op">=</span> <span class="va">s2_mu</span><span class="op">)</span>          <span class="co"># Base measure: mean</span></span>
<span>    <span class="va">s2Tilde</span><span class="op">[</span><span class="va">m</span><span class="op">]</span>  <span class="op">~</span> <span class="fu"><a href="https://rdrr.io/pkg/nimble/man/Inverse-Gamma.html" class="external-link">dinvgamma</a></span><span class="op">(</span><span class="va">nu1</span>, <span class="va">nu2</span><span class="op">)</span>            <span class="co"># Base measure: variance</span></span>
<span>  <span class="op">}</span></span>
<span></span>
<span>  <span class="co"># --- Log-probability monitoring nodes ---</span></span>
<span>  <span class="va">myLogProbAll</span>  <span class="op">~</span> <span class="fu"><a href="https://rdrr.io/r/stats/Normal.html" class="external-link">dnorm</a></span><span class="op">(</span><span class="fl">0</span>, <span class="fl">1</span><span class="op">)</span>                    <span class="co"># Replaced by logProb_summer</span></span>
<span>  <span class="va">myLogProbSome</span> <span class="op">~</span> <span class="fu"><a href="https://rdrr.io/r/stats/Normal.html" class="external-link">dnorm</a></span><span class="op">(</span><span class="fl">0</span>, <span class="fl">1</span><span class="op">)</span></span>
<span>  <span class="va">myLogLik</span>      <span class="op">~</span> <span class="fu"><a href="https://rdrr.io/r/stats/Normal.html" class="external-link">dnorm</a></span><span class="op">(</span><span class="fl">0</span>, <span class="fl">1</span><span class="op">)</span></span>
<span><span class="op">}</span><span class="op">)</span></span></code></pre>
<p>Key design choices:</p>
<ul>
<li>
<strong>CRP representation</strong>:
<code>dCRP(alpha, size = N)</code> uses the Chinese Restaurant Process
to assign each person to a cluster. NIMBLE handles the stick-breaking
conversion internally.</li>
<li>
<strong>Truncation</strong>: <code>M = 50</code> clusters
(configurable) are pre-allocated. The CRP can use fewer but never
more.</li>
<li>
<strong>Dummy monitoring nodes</strong>: <code>myLogProbAll</code>,
<code>myLogProbSome</code>, and <code>myLogLik</code> are declared as
dummy <code>dnorm(0,1)</code> nodes. Their default samplers are replaced
by <code>logProb_summer</code> during MCMC configuration (see
below).</li>
</ul>
</div>
</div>
<div class="section level2">
<h2 id="custom-nimble-components">Custom NIMBLE Components<a class="anchor" aria-label="anchor" href="#custom-nimble-components"></a>
</h2>
<p>DPMirt registers three custom NIMBLE components, all adapted from
Paganin et al. (2023) and implemented using a lazy-initialization
pattern to avoid executing <code><a href="https://rdrr.io/pkg/nimble/man/nimbleFunction.html" class="external-link">nimbleFunction()</a></code> at package load
time.</p>
<table class="table">
<caption>Custom NIMBLE components registered by DPMirt.</caption>
<colgroup>
<col width="11%">
<col width="8%">
<col width="53%">
<col width="25%">
</colgroup>
<thead><tr class="header">
<th align="left">Component</th>
<th align="left">Type</th>
<th align="left">Purpose</th>
<th align="left">When_Used</th>
</tr></thead>
<tbody>
<tr class="odd">
<td align="left">dBernoulliVector</td>
<td align="left">Distribution</td>
<td align="left">Vectorized Bernoulli likelihood for constrained_item
identification</td>
<td align="left">constrained_item with 2PL/3PL only</td>
</tr>
<tr class="even">
<td align="left">logProb_summer</td>
<td align="left">Sampler</td>
<td align="left">Log-probability monitoring: tracks logProb(all),
logProb(params), logLik(data)</td>
<td align="left">Always (all models, all priors)</td>
</tr>
<tr class="odd">
<td align="left">sampler_centered</td>
<td align="left">Sampler</td>
<td align="left">Joint adaptive MH for correlated (log_lambda, gamma) in
SI parameterization</td>
<td align="left">2PL/3PL with SI parameterization only</td>
</tr>
</tbody>
</table>
<div class="section level3">
<h3 id="dbernoullivector">dBernoulliVector<a class="anchor" aria-label="anchor" href="#dbernoullivector"></a>
</h3>
<p>For <code>constrained_item</code> identification in 2PL/3PL models,
the likelihood for each person’s entire response vector is evaluated
jointly:</p>
<pre><code><span><span class="va">y</span><span class="op">[</span><span class="va">j</span>, <span class="fl">1</span><span class="op">:</span><span class="va">I</span><span class="op">]</span> <span class="op">~</span> <span class="fu">dBernoulliVector</span><span class="op">(</span>prob <span class="op">=</span> <span class="va">pi</span><span class="op">[</span><span class="va">j</span>, <span class="fl">1</span><span class="op">:</span><span class="va">I</span><span class="op">]</span><span class="op">)</span></span></code></pre>
<p>This is necessary because the constraint
<code>beta[1:I] &lt;- beta.tmp[1:I] - mean(beta.tmp[1:I])</code> creates
a deterministic dependency across all items, requiring a vectorized
likelihood.</p>
<p>The density function sums element-wise Bernoulli
log-probabilities:</p>
<div class="sourceCode" id="cb7"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Simplified version of the registered nimbleFunction</span></span>
<span><span class="va">dBernoulliVector</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">x</span>, <span class="va">prob</span>, <span class="va">log</span> <span class="op">=</span> <span class="fl">0</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="va">logProb</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/sum.html" class="external-link">sum</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/stats/Binomial.html" class="external-link">dbinom</a></span><span class="op">(</span><span class="va">x</span>, size <span class="op">=</span> <span class="fl">1</span>, prob <span class="op">=</span> <span class="va">prob</span>, log <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span><span class="op">)</span></span>
<span>  <span class="kw">if</span> <span class="op">(</span><span class="va">log</span><span class="op">)</span> <span class="kw"><a href="https://rdrr.io/r/base/function.html" class="external-link">return</a></span><span class="op">(</span><span class="va">logProb</span><span class="op">)</span> <span class="kw">else</span> <span class="kw"><a href="https://rdrr.io/r/base/function.html" class="external-link">return</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/Log.html" class="external-link">exp</a></span><span class="op">(</span><span class="va">logProb</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="op">}</span></span></code></pre></div>
</div>
<div class="section level3">
<h3 id="logprob_summer">logProb_summer<a class="anchor" aria-label="anchor" href="#logprob_summer"></a>
</h3>
<p>This pseudo-sampler does not propose new values — it computes and
stores the log-probability of a set of nodes at each MCMC iteration.
Three instances are configured:</p>
<table class="table">
<colgroup>
<col width="33%">
<col width="41%">
<col width="25%">
</colgroup>
<thead><tr class="header">
<th align="left">Target node</th>
<th align="left">What it tracks</th>
<th align="left">nodeList</th>
</tr></thead>
<tbody>
<tr class="odd">
<td align="left"><code>myLogProbAll</code></td>
<td align="left">Total model log-probability</td>
<td align="left">All nodes</td>
</tr>
<tr class="even">
<td align="left"><code>myLogProbSome</code></td>
<td align="left">Parameter log-probability</td>
<td align="left">
<code>c("beta", "eta")</code> or
<code>c("gamma", "lambda", "eta")</code>
</td>
</tr>
<tr class="odd">
<td align="left"><code>myLogLik</code></td>
<td align="left">Data log-likelihood</td>
<td align="left"><code>"y"</code></td>
</tr>
</tbody>
</table>
<p>The <code>myLogLik</code> trace is used for: - Visual convergence
checking (trace plots). - WAIC computation (when NIMBLE’s built-in WAIC
is not available).</p>
</div>
<div class="section level3">
<h3 id="sampler_centered">sampler_centered<a class="anchor" aria-label="anchor" href="#sampler_centered"></a>
</h3>
<p>The centered sampler is critical for efficient mixing in the
slope-intercept (SI) parameterization of 2PL and 3PL models. It
addresses the strong posterior correlation between
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mrow><mi mathvariant="normal">log</mi><mo>⁡</mo></mrow><msub><mi>λ</mi><mi>i</mi></msub></mrow><annotation encoding="application/x-tex">\log\lambda_i</annotation></semantics></math>
and
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><msub><mi>γ</mi><mi>i</mi></msub><annotation encoding="application/x-tex">\gamma_i</annotation></semantics></math>
by making a joint proposal:</p>
<ol style="list-style-type: decimal">
<li>
<strong>Propose</strong>
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mrow><mi mathvariant="normal">log</mi><mo>⁡</mo></mrow><msubsup><mi>λ</mi><mi>i</mi><mo>′</mo></msubsup><mo>=</mo><mrow><mi mathvariant="normal">log</mi><mo>⁡</mo></mrow><msub><mi>λ</mi><mi>i</mi></msub><mo>+</mo><mi>ϵ</mi></mrow><annotation encoding="application/x-tex">\log\lambda'_i = \log\lambda_i + \epsilon</annotation></semantics></math>,
where
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>ϵ</mi><mo>∼</mo><mi>N</mi><mo stretchy="false" form="prefix">(</mo><mn>0</mn><mo>,</mo><msup><mtext mathvariant="normal">scale</mtext><mn>2</mn></msup><mo stretchy="false" form="postfix">)</mo></mrow><annotation encoding="application/x-tex">\epsilon \sim N(0, \text{scale}^2)</annotation></semantics></math>.</li>
<li>
<strong>Center</strong>
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msubsup><mi>γ</mi><mi>i</mi><mo>′</mo></msubsup><mo>=</mo><msub><mi>γ</mi><mi>i</mi></msub><mo>+</mo><mover><mi>η</mi><mo accent="true">‾</mo></mover><mo>⋅</mo><mo stretchy="false" form="prefix">(</mo><mrow><mi mathvariant="normal">exp</mi><mo>⁡</mo></mrow><mo stretchy="false" form="prefix">(</mo><mrow><mi mathvariant="normal">log</mi><mo>⁡</mo></mrow><msub><mi>λ</mi><mi>i</mi></msub><mo stretchy="false" form="postfix">)</mo><mo>−</mo><mrow><mi mathvariant="normal">exp</mi><mo>⁡</mo></mrow><mo stretchy="false" form="prefix">(</mo><mrow><mi mathvariant="normal">log</mi><mo>⁡</mo></mrow><msubsup><mi>λ</mi><mi>i</mi><mo>′</mo></msubsup><mo stretchy="false" form="postfix">)</mo><mo stretchy="false" form="postfix">)</mo></mrow><annotation encoding="application/x-tex">\gamma'_i = \gamma_i + \bar\eta \cdot
(\exp(\log\lambda_i) - \exp(\log\lambda'_i))</annotation></semantics></math>.</li>
<li>
<strong>Accept/reject</strong> via Metropolis-Hastings.</li>
</ol>
<p>The centering mean
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mover><mi>η</mi><mo accent="true">‾</mo></mover><annotation encoding="application/x-tex">\bar\eta</annotation></semantics></math>
is updated each iteration to <code>mean(eta)</code>. Adaptive scaling
targets an acceptance rate of 0.44 (optimal for univariate random-walk
MH).</p>
<blockquote>
<p><strong>When is it used?</strong> Only for 2PL/3PL models with SI
parameterization and <code>identification = "unconstrained"</code> or
<code>"constrained_ability"</code>. For the IRT parameterization,
NIMBLE’s default samplers are sufficient because the correlation
structure is different.</p>
</blockquote>
<p>The <code><a href="../reference/dpmirt_compile.html">dpmirt_compile()</a></code> function automatically enables the
centered sampler when <code>use_centered_sampler = "auto"</code> (the
default).</p>
</div>
</div>
<div class="section level2">
<h2 id="compile-once-sample-many-pattern">Compile-Once, Sample-Many Pattern<a class="anchor" aria-label="anchor" href="#compile-once-sample-many-pattern"></a>
</h2>
<p>NIMBLE compilation translates the model and MCMC configuration into
C++ code, compiles it, and loads the resulting shared library. This is
the most expensive step in the pipeline.</p>
<p>DPMirt separates compilation from sampling, allowing you to compile
once and then run multiple chains, extend runs, or experiment with
different MCMC lengths — all without recompiling.</p>
<div class="section level3">
<h3 id="architecture">Architecture<a class="anchor" aria-label="anchor" href="#architecture"></a>
</h3>
<pre><code>dpmirt_spec()  ──&gt;  dpmirt_compile()  ──&gt;  dpmirt_sample()
  [&lt; 1 sec]        [30-120 sec]           [10-60 sec per call]
                         │
                         ├── dpmirt_sample(seed = 1)
                         ├── dpmirt_sample(seed = 2)
                         ├── dpmirt_sample(seed = 3)
                         └── dpmirt_sample(seed = 4)</code></pre>
</div>
<div class="section level3">
<h3 id="timing-table">Timing Table<a class="anchor" aria-label="anchor" href="#timing-table"></a>
</h3>
<table class="table">
<caption>Typical timing for each pipeline stage (Rasch, N=200,
I=25).</caption>
<thead><tr class="header">
<th align="left">Operation</th>
<th align="left">Typical_Time</th>
<th align="left">Bottleneck</th>
</tr></thead>
<tbody>
<tr class="odd">
<td align="left">dpmirt_spec()</td>
<td align="left">&lt; 1 sec</td>
<td align="left">Code generation</td>
</tr>
<tr class="even">
<td align="left">dpmirt_compile()</td>
<td align="left">30-120 sec</td>
<td align="left">C++ compilation</td>
</tr>
<tr class="odd">
<td align="left">dpmirt_sample(10K)</td>
<td align="left">10-60 sec</td>
<td align="left">MCMC iterations</td>
</tr>
<tr class="even">
<td align="left">dpmirt_rescale()</td>
<td align="left">&lt; 1 sec</td>
<td align="left">Matrix operations</td>
</tr>
<tr class="odd">
<td align="left">dpmirt_estimates()</td>
<td align="left">&lt; 1 sec</td>
<td align="left">Quantile computation</td>
</tr>
</tbody>
</table>
</div>
<div class="section level3">
<h3 id="step-by-step-workflow">Step-by-Step Workflow<a class="anchor" aria-label="anchor" href="#step-by-step-workflow"></a>
</h3>
<div class="sourceCode" id="cb9"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Step 1: Specification (fast)</span></span>
<span><span class="va">spec</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/dpmirt_spec.html">dpmirt_spec</a></span><span class="op">(</span><span class="va">sim</span><span class="op">$</span><span class="va">response</span>, model <span class="op">=</span> <span class="st">"rasch"</span>, prior <span class="op">=</span> <span class="st">"dpm"</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Step 2: Compilation (expensive --- do this once)</span></span>
<span><span class="va">compiled</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/dpmirt_compile.html">dpmirt_compile</a></span><span class="op">(</span><span class="va">spec</span>, verbose <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Step 3: Multiple chains (fast --- reuse compiled object)</span></span>
<span><span class="va">chains</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/lapply.html" class="external-link">lapply</a></span><span class="op">(</span><span class="fl">1</span><span class="op">:</span><span class="fl">4</span>, <span class="kw">function</span><span class="op">(</span><span class="va">i</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="fu"><a href="../reference/dpmirt_sample.html">dpmirt_sample</a></span><span class="op">(</span><span class="va">compiled</span>, niter <span class="op">=</span> <span class="fl">10000</span>, nburnin <span class="op">=</span> <span class="fl">2000</span>, seed <span class="op">=</span> <span class="va">i</span><span class="op">)</span></span>
<span><span class="op">}</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Step 4: Chain continuation (extend without recompiling)</span></span>
<span><span class="co"># Option A: low-level via dpmirt_sample with reset = FALSE</span></span>
<span><span class="va">extended</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/dpmirt_sample.html">dpmirt_sample</a></span><span class="op">(</span><span class="va">compiled</span>, niter <span class="op">=</span> <span class="fl">5000</span>, nburnin <span class="op">=</span> <span class="fl">0</span>,</span>
<span>                           reset <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Option B: higher-level via dpmirt_resume (preferred)</span></span>
<span><span class="co"># extended &lt;- dpmirt_resume(compiled, niter = 5000)</span></span></code></pre></div>
</div>
<div class="section level3">
<h3 id="custom-sampler-configuration">Custom Sampler Configuration<a class="anchor" aria-label="anchor" href="#custom-sampler-configuration"></a>
</h3>
<p>For advanced users, <code><a href="../reference/dpmirt_compile.html">dpmirt_compile()</a></code> accepts a custom
sampler configuration function:</p>
<div class="sourceCode" id="cb10"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Define a custom sampler configuration function</span></span>
<span><span class="va">my_config</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">conf</span>, <span class="va">model</span>, <span class="va">spec</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="co"># Remove all default samplers for eta</span></span>
<span>  <span class="kw">for</span> <span class="op">(</span><span class="va">j</span> <span class="kw">in</span> <span class="fu"><a href="https://rdrr.io/r/base/seq.html" class="external-link">seq_len</a></span><span class="op">(</span><span class="va">spec</span><span class="op">$</span><span class="va">config</span><span class="op">$</span><span class="va">N</span><span class="op">)</span><span class="op">)</span> <span class="op">{</span></span>
<span>    <span class="va">conf</span><span class="op">$</span><span class="fu">removeSamplers</span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/paste.html" class="external-link">paste0</a></span><span class="op">(</span><span class="st">"eta["</span>, <span class="va">j</span>, <span class="st">"]"</span><span class="op">)</span><span class="op">)</span></span>
<span>  <span class="op">}</span></span>
<span></span>
<span>  <span class="co"># Add slice samplers instead of the default RW</span></span>
<span>  <span class="kw">for</span> <span class="op">(</span><span class="va">j</span> <span class="kw">in</span> <span class="fu"><a href="https://rdrr.io/r/base/seq.html" class="external-link">seq_len</a></span><span class="op">(</span><span class="va">spec</span><span class="op">$</span><span class="va">config</span><span class="op">$</span><span class="va">N</span><span class="op">)</span><span class="op">)</span> <span class="op">{</span></span>
<span>    <span class="va">conf</span><span class="op">$</span><span class="fu">addSampler</span><span class="op">(</span></span>
<span>      target <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/paste.html" class="external-link">paste0</a></span><span class="op">(</span><span class="st">"eta["</span>, <span class="va">j</span>, <span class="st">"]"</span><span class="op">)</span>,</span>
<span>      type   <span class="op">=</span> <span class="st">"slice"</span></span>
<span>    <span class="op">)</span></span>
<span>  <span class="op">}</span></span>
<span></span>
<span>  <span class="va">conf</span></span>
<span><span class="op">}</span></span>
<span></span>
<span><span class="va">compiled</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/dpmirt_compile.html">dpmirt_compile</a></span><span class="op">(</span><span class="va">spec</span>, sampler_config <span class="op">=</span> <span class="va">my_config</span><span class="op">)</span></span></code></pre></div>
<blockquote>
<p><strong>Serialization caveat:</strong> Compiled NIMBLE objects
contain external C++ pointers that <strong>cannot be serialized</strong>
across R sessions. If you call <code>saveRDS(compiled, ...)</code> and
then <code>readRDS(...)</code> in a new session, the pointers will be
dead and all MCMC operations will fail. Instead, save the
<code>dpmirt_spec</code> object and recompile:</p>
<div class="sourceCode" id="cb11"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># CORRECT: Save spec, recompile in new session</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/readRDS.html" class="external-link">saveRDS</a></span><span class="op">(</span><span class="va">spec</span>, <span class="st">"my_spec.rds"</span><span class="op">)</span></span>
<span><span class="co"># ... in new R session ...</span></span>
<span><span class="va">spec</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/readRDS.html" class="external-link">readRDS</a></span><span class="op">(</span><span class="st">"my_spec.rds"</span><span class="op">)</span></span>
<span><span class="va">compiled</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/dpmirt_compile.html">dpmirt_compile</a></span><span class="op">(</span><span class="va">spec</span><span class="op">)</span></span></code></pre></div>
</blockquote>
</div>
<div class="section level3">
<h3 id="accessing-nimble-objects-directly">Accessing NIMBLE Objects Directly<a class="anchor" aria-label="anchor" href="#accessing-nimble-objects-directly"></a>
</h3>
<p>The compiled object provides direct access to the underlying NIMBLE
objects for advanced manipulation:</p>
<div class="sourceCode" id="cb12"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># The compiled NIMBLE model (C object)</span></span>
<span><span class="va">compiled</span><span class="op">$</span><span class="va">Cmodel</span></span>
<span></span>
<span><span class="co"># The compiled MCMC (C object)</span></span>
<span><span class="va">compiled</span><span class="op">$</span><span class="va">Cmcmc</span></span>
<span></span>
<span><span class="co"># List all node names</span></span>
<span><span class="va">compiled</span><span class="op">$</span><span class="va">Cmodel</span><span class="op">$</span><span class="fu">getNodeNames</span><span class="op">(</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Get current values of a parameter</span></span>
<span><span class="va">compiled</span><span class="op">$</span><span class="va">Cmodel</span><span class="op">$</span><span class="va">eta</span></span>
<span></span>
<span><span class="co"># Calculate log-probability of the current model state</span></span>
<span><span class="va">compiled</span><span class="op">$</span><span class="va">Cmodel</span><span class="op">$</span><span class="fu">calculate</span><span class="op">(</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Inspect sampler configuration</span></span>
<span><span class="va">compiled</span><span class="op">$</span><span class="va">mcmc_conf</span><span class="op">$</span><span class="fu">printSamplers</span><span class="op">(</span><span class="op">)</span></span></code></pre></div>
</div>
</div>
<div class="section level2">
<h2 id="post-hoc-rescaling-implementation">Post-hoc Rescaling Implementation<a class="anchor" aria-label="anchor" href="#post-hoc-rescaling-implementation"></a>
</h2>
<p>IRT models have identification indeterminacy: without constraints,
the likelihood is invariant to certain transformations of the
parameters. DPMirt’s default approach is to leave the model
unconstrained during MCMC and apply rescaling to the posterior samples
afterwards.</p>
<div class="section level3">
<h3 id="rasch-location-shift-only">Rasch: Location Shift Only<a class="anchor" aria-label="anchor" href="#rasch-location-shift-only"></a>
</h3>
<p>The Rasch model has only location indeterminacy. For each MCMC
iteration
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mi>s</mi><annotation encoding="application/x-tex">s</annotation></semantics></math>,
the rescaling is:</p>
<p><math display="block" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msubsup><mi>β</mi><mrow><mi>i</mi><mo>,</mo><mi>s</mi></mrow><mo>*</mo></msubsup><mo>=</mo><msub><mi>β</mi><mrow><mi>i</mi><mo>,</mo><mi>s</mi></mrow></msub><mo>−</mo><msub><mover><mi>β</mi><mo accent="true">‾</mo></mover><mi>s</mi></msub><mo>,</mo><mspace width="2.0em"></mspace><msubsup><mi>θ</mi><mrow><mi>p</mi><mo>,</mo><mi>s</mi></mrow><mo>*</mo></msubsup><mo>=</mo><msub><mi>θ</mi><mrow><mi>p</mi><mo>,</mo><mi>s</mi></mrow></msub><mo>−</mo><msub><mover><mi>β</mi><mo accent="true">‾</mo></mover><mi>s</mi></msub></mrow><annotation encoding="application/x-tex">
\beta^*_{i,s} = \beta_{i,s} - \bar{\beta}_s, \qquad
\theta^*_{p,s} = \theta_{p,s} - \bar{\beta}_s
</annotation></semantics></math></p>
<p>where
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mover><mi>β</mi><mo accent="true">‾</mo></mover><mi>s</mi></msub><mo>=</mo><mfrac><mn>1</mn><mi>I</mi></mfrac><msubsup><mo>∑</mo><mrow><mi>i</mi><mo>=</mo><mn>1</mn></mrow><mi>I</mi></msubsup><msub><mi>β</mi><mrow><mi>i</mi><mo>,</mo><mi>s</mi></mrow></msub></mrow><annotation encoding="application/x-tex">\bar{\beta}_s = \frac{1}{I}\sum_{i=1}^I \beta_{i,s}</annotation></semantics></math>.</p>
<p><strong>Invariant check:</strong> After rescaling,
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mo stretchy="false" form="prefix">|</mo><msubsup><mover><mi>β</mi><mo accent="true">‾</mo></mover><mi>s</mi><mo>*</mo></msubsup><mo stretchy="false" form="prefix">|</mo><mo>&lt;</mo><mi>ϵ</mi></mrow><annotation encoding="application/x-tex">|\bar{\beta}^*_s| &lt; \epsilon</annotation></semantics></math>
for every iteration.</p>
</div>
<div class="section level3">
<h3 id="pl-irt-location-scale">2PL IRT: Location + Scale<a class="anchor" aria-label="anchor" href="#pl-irt-location-scale"></a>
</h3>
<p>The 2PL model has both location and scale indeterminacy. For each
iteration
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mi>s</mi><annotation encoding="application/x-tex">s</annotation></semantics></math>:</p>
<p><math display="block" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mtext mathvariant="normal">location</mtext><mi>s</mi></msub><mo>=</mo><msub><mover><mi>β</mi><mo accent="true">‾</mo></mover><mi>s</mi></msub><mo>,</mo><mspace width="2.0em"></mspace><msub><mtext mathvariant="normal">scale</mtext><mi>s</mi></msub><mo>=</mo><msup><mrow><mo stretchy="true" form="prefix">(</mo><munderover><mo>∏</mo><mrow><mi>i</mi><mo>=</mo><mn>1</mn></mrow><mi>I</mi></munderover><msub><mi>λ</mi><mrow><mi>i</mi><mo>,</mo><mi>s</mi></mrow></msub><mo stretchy="true" form="postfix">)</mo></mrow><mrow><mi>−</mi><mn>1</mn><mi>/</mi><mi>I</mi></mrow></msup></mrow><annotation encoding="application/x-tex">
\text{location}_s = \bar{\beta}_s, \qquad
\text{scale}_s = \left(\prod_{i=1}^I \lambda_{i,s}\right)^{-1/I}
</annotation></semantics></math></p>
<p><math display="block" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msubsup><mi>β</mi><mrow><mi>i</mi><mo>,</mo><mi>s</mi></mrow><mo>*</mo></msubsup><mo>=</mo><mfrac><mrow><msub><mi>β</mi><mrow><mi>i</mi><mo>,</mo><mi>s</mi></mrow></msub><mo>−</mo><msub><mtext mathvariant="normal">location</mtext><mi>s</mi></msub></mrow><msub><mtext mathvariant="normal">scale</mtext><mi>s</mi></msub></mfrac><mo>,</mo><mspace width="2.0em"></mspace><msubsup><mi>λ</mi><mrow><mi>i</mi><mo>,</mo><mi>s</mi></mrow><mo>*</mo></msubsup><mo>=</mo><msub><mi>λ</mi><mrow><mi>i</mi><mo>,</mo><mi>s</mi></mrow></msub><mo>⋅</mo><msub><mtext mathvariant="normal">scale</mtext><mi>s</mi></msub><mo>,</mo><mspace width="2.0em"></mspace><msubsup><mi>θ</mi><mrow><mi>p</mi><mo>,</mo><mi>s</mi></mrow><mo>*</mo></msubsup><mo>=</mo><mfrac><mrow><msub><mi>θ</mi><mrow><mi>p</mi><mo>,</mo><mi>s</mi></mrow></msub><mo>−</mo><msub><mtext mathvariant="normal">location</mtext><mi>s</mi></msub></mrow><msub><mtext mathvariant="normal">scale</mtext><mi>s</mi></msub></mfrac></mrow><annotation encoding="application/x-tex">
\beta^*_{i,s} = \frac{\beta_{i,s} - \text{location}_s}{\text{scale}_s}, \qquad
\lambda^*_{i,s} = \lambda_{i,s} \cdot \text{scale}_s, \qquad
\theta^*_{p,s} = \frac{\theta_{p,s} - \text{location}_s}{\text{scale}_s}
</annotation></semantics></math></p>
<p><strong>Invariant checks:</strong> -
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mo stretchy="false" form="prefix">|</mo><msubsup><mover><mi>β</mi><mo accent="true">‾</mo></mover><mi>s</mi><mo>*</mo></msubsup><mo stretchy="false" form="prefix">|</mo><mo>&lt;</mo><mi>ϵ</mi></mrow><annotation encoding="application/x-tex">|\bar{\beta}^*_s| &lt; \epsilon</annotation></semantics></math>
-
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mo stretchy="false" form="prefix">|</mo><mtext mathvariant="normal">geom_mean</mtext><mo stretchy="false" form="prefix">(</mo><msubsup><mi>λ</mi><mi>s</mi><mo>*</mo></msubsup><mo stretchy="false" form="postfix">)</mo><mo>−</mo><mn>1</mn><mo stretchy="false" form="prefix">|</mo><mo>&lt;</mo><mi>ϵ</mi></mrow><annotation encoding="application/x-tex">|\text{geom\_mean}(\lambda^*_s) - 1| &lt; \epsilon</annotation></semantics></math></p>
</div>
<div class="section level3">
<h3 id="pl-si-different-sign-convention">2PL SI: Different Sign Convention<a class="anchor" aria-label="anchor" href="#pl-si-different-sign-convention"></a>
</h3>
<p>For the slope-intercept parameterization
(<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mtext mathvariant="normal">logit</mtext><mo stretchy="false" form="prefix">(</mo><mi>p</mi><mo stretchy="false" form="postfix">)</mo><mo>=</mo><mi>λ</mi><mi>θ</mi><mo>+</mo><mi>γ</mi></mrow><annotation encoding="application/x-tex">\text{logit}(p) = \lambda\theta + \gamma</annotation></semantics></math>),
the location shift has opposite sign because
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>γ</mi><mo>=</mo><mi>−</mi><mi>λ</mi><mi>β</mi></mrow><annotation encoding="application/x-tex">\gamma = -\lambda\beta</annotation></semantics></math>:</p>
<p><math display="block" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mtext mathvariant="normal">location</mtext><mi>s</mi></msub><mo>=</mo><mfrac><mrow><munder><mo>∑</mo><mi>i</mi></munder><msub><mi>γ</mi><mrow><mi>i</mi><mo>,</mo><mi>s</mi></mrow></msub></mrow><mrow><munder><mo>∑</mo><mi>i</mi></munder><msub><mi>λ</mi><mrow><mi>i</mi><mo>,</mo><mi>s</mi></mrow></msub></mrow></mfrac></mrow><annotation encoding="application/x-tex">
\text{location}_s = \frac{\sum_i \gamma_{i,s}}{\sum_i \lambda_{i,s}}
</annotation></semantics></math></p>
<p><math display="block" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msubsup><mi>γ</mi><mrow><mi>i</mi><mo>,</mo><mi>s</mi></mrow><mo>*</mo></msubsup><mo>=</mo><msub><mi>γ</mi><mrow><mi>i</mi><mo>,</mo><mi>s</mi></mrow></msub><mo>−</mo><msub><mi>λ</mi><mrow><mi>i</mi><mo>,</mo><mi>s</mi></mrow></msub><mo>⋅</mo><msub><mtext mathvariant="normal">location</mtext><mi>s</mi></msub><mo>,</mo><mspace width="2.0em"></mspace><msubsup><mi>θ</mi><mrow><mi>p</mi><mo>,</mo><mi>s</mi></mrow><mo>*</mo></msubsup><mo>=</mo><mfrac><mrow><msub><mi>θ</mi><mrow><mi>p</mi><mo>,</mo><mi>s</mi></mrow></msub><mo>+</mo><msub><mtext mathvariant="normal">location</mtext><mi>s</mi></msub></mrow><msub><mtext mathvariant="normal">scale</mtext><mi>s</mi></msub></mfrac></mrow><annotation encoding="application/x-tex">
\gamma^*_{i,s} = \gamma_{i,s} - \lambda_{i,s} \cdot \text{location}_s, \qquad
\theta^*_{p,s} = \frac{\theta_{p,s} + \text{location}_s}{\text{scale}_s}
</annotation></semantics></math></p>
<p>Note the
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mi>+</mi><annotation encoding="application/x-tex">+</annotation></semantics></math>
sign for theta rescaling
(vs. <math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mi>−</mi><annotation encoding="application/x-tex">-</annotation></semantics></math>
in IRT parameterization).</p>
</div>
<div class="section level3">
<h3 id="why-post-hoc">Why Post-hoc?<a class="anchor" aria-label="anchor" href="#why-post-hoc"></a>
</h3>
<p>Post-hoc rescaling has two advantages over in-MCMC constraints:</p>
<ol style="list-style-type: decimal">
<li>
<strong>Simpler MCMC</strong>: The unconstrained model has a simpler
posterior geometry, avoiding the need for constrained samplers.</li>
<li>
<strong>Flexibility</strong>: Different identification conventions
can be applied to the same posterior samples without re-running the
MCMC.</li>
</ol>
<p>The disadvantage is that the raw (unrescaled) samples may have poor
mixing if the location/scale dimensions are poorly identified. In
practice, DPMirt’s default priors provide sufficient regularization.</p>
</div>
</div>
<div class="section level2">
<h2 id="dp-density-reconstruction">DP Density Reconstruction<a class="anchor" aria-label="anchor" href="#dp-density-reconstruction"></a>
</h2>
<p>For DPM models, DPMirt can reconstruct the posterior predictive
density of the latent trait. This follows Paganin et al.’s
<code><a href="https://rdrr.io/pkg/nimble/man/getSamplesDPmeasure.html" class="external-link">getSamplesDPmeasure()</a></code> approach.</p>
<div class="section level3">
<h3 id="algorithm">Algorithm<a class="anchor" aria-label="anchor" href="#algorithm"></a>
</h3>
<p>For each post-burn-in MCMC iteration
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mi>s</mi><annotation encoding="application/x-tex">s</annotation></semantics></math>:</p>
<ol style="list-style-type: decimal">
<li><p><strong>Extract</strong> the stick-breaking weights
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>w</mi><mrow><mi>s</mi><mo>,</mo><mn>1</mn></mrow></msub><mo>,</mo><mi>…</mi><mo>,</mo><msub><mi>w</mi><mrow><mi>s</mi><mo>,</mo><msub><mi>K</mi><mi>s</mi></msub></mrow></msub></mrow><annotation encoding="application/x-tex">w_{s,1}, \ldots, w_{s,K_s}</annotation></semantics></math>
and atoms
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mo stretchy="false" form="prefix">(</mo><msub><mover><mi>μ</mi><mo accent="true">̃</mo></mover><mrow><mi>s</mi><mo>,</mo><mi>k</mi></mrow></msub><mo>,</mo><msubsup><mover><mi>σ</mi><mo accent="true">̃</mo></mover><mrow><mi>s</mi><mo>,</mo><mi>k</mi></mrow><mn>2</mn></msubsup><mo stretchy="false" form="postfix">)</mo></mrow><annotation encoding="application/x-tex">(\tilde\mu_{s,k}, \tilde\sigma^2_{s,k})</annotation></semantics></math>
from the CRP posterior via NIMBLE’s
<code><a href="https://rdrr.io/pkg/nimble/man/getSamplesDPmeasure.html" class="external-link">getSamplesDPmeasure()</a></code>.</p></li>
<li><p><strong>Evaluate</strong> the finite mixture density on a
grid:</p></li>
</ol>
<p><math display="block" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>f</mi><mi>s</mi></msub><mo stretchy="false" form="prefix">(</mo><mi>x</mi><mo stretchy="false" form="postfix">)</mo><mo>=</mo><munderover><mo>∑</mo><mrow><mi>k</mi><mo>=</mo><mn>1</mn></mrow><msub><mi>K</mi><mi>s</mi></msub></munderover><msub><mi>w</mi><mrow><mi>s</mi><mo>,</mo><mi>k</mi></mrow></msub><mo>⋅</mo><mi>ϕ</mi><mspace width="-0.167em"></mspace><mrow><mo stretchy="true" form="prefix">(</mo><mi>x</mi><mo>;</mo><mspace width="0.167em"></mspace><msub><mover><mi>μ</mi><mo accent="true">̃</mo></mover><mrow><mi>s</mi><mo>,</mo><mi>k</mi></mrow></msub><mo>,</mo><mspace width="0.167em"></mspace><msubsup><mover><mi>σ</mi><mo accent="true">̃</mo></mover><mrow><mi>s</mi><mo>,</mo><mi>k</mi></mrow><mn>2</mn></msubsup><mo stretchy="true" form="postfix">)</mo></mrow></mrow><annotation encoding="application/x-tex">
f_s(x) = \sum_{k=1}^{K_s} w_{s,k} \cdot \phi\!\left(x;\, \tilde\mu_{s,k},\, \tilde\sigma^2_{s,k}\right)
</annotation></semantics></math></p>
<p>where
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>ϕ</mi><mo stretchy="false" form="prefix">(</mo><mi>x</mi><mo>;</mo><mi>μ</mi><mo>,</mo><msup><mi>σ</mi><mn>2</mn></msup><mo stretchy="false" form="postfix">)</mo></mrow><annotation encoding="application/x-tex">\phi(x; \mu, \sigma^2)</annotation></semantics></math>
is the Normal density.</p>
<ol start="3" style="list-style-type: decimal">
<li>
<strong>Average</strong> over iterations for the posterior
predictive mean:</li>
</ol>
<p><math display="block" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mover><mi>f</mi><mo accent="true">̂</mo></mover><mo stretchy="false" form="prefix">(</mo><mi>x</mi><mo stretchy="false" form="postfix">)</mo><mo>=</mo><mfrac><mn>1</mn><mi>S</mi></mfrac><munderover><mo>∑</mo><mrow><mi>s</mi><mo>=</mo><mn>1</mn></mrow><mi>S</mi></munderover><msub><mi>f</mi><mi>s</mi></msub><mo stretchy="false" form="prefix">(</mo><mi>x</mi><mo stretchy="false" form="postfix">)</mo></mrow><annotation encoding="application/x-tex">
\hat{f}(x) = \frac{1}{S}\sum_{s=1}^S f_s(x)
</annotation></semantics></math></p>
<ol start="4" style="list-style-type: decimal">
<li>
<strong>Pointwise credible bands</strong>: Take quantiles across
iterations at each grid point.</li>
</ol>
</div>
<div class="section level3">
<h3 id="rescaling-adjustment">Rescaling Adjustment<a class="anchor" aria-label="anchor" href="#rescaling-adjustment"></a>
</h3>
<p>For unconstrained models, the DP density is on the raw (unrescaled)
scale. To evaluate it on the rescaled theta scale, the grid is shifted
by the iteration-specific location shift:</p>
<p><math display="block" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mover><mi>f</mi><mo accent="true">̂</mo></mover><mtext mathvariant="normal">rescaled</mtext></msub><mo stretchy="false" form="prefix">(</mo><mi>x</mi><mo stretchy="false" form="postfix">)</mo><mo>=</mo><msub><mi>f</mi><mi>s</mi></msub><mo stretchy="false" form="prefix">(</mo><mi>x</mi><mo>+</mo><msub><mtext mathvariant="normal">location</mtext><mi>s</mi></msub><mo stretchy="false" form="postfix">)</mo></mrow><annotation encoding="application/x-tex">
\hat{f}_{\text{rescaled}}(x) = f_s(x + \text{location}_s)
</annotation></semantics></math></p>
<p>The Jacobian is 1 for a location shift, so no density adjustment is
needed.</p>
</div>
<div class="section level3">
<h3 id="using-dpmirt_dp_density">Using <code>dpmirt_dp_density()</code><a class="anchor" aria-label="anchor" href="#using-dpmirt_dp_density"></a>
</h3>
<div class="sourceCode" id="cb13"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Compute DP density from a fitted DPM model</span></span>
<span><span class="va">dp_dens</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/dpmirt_dp_density.html">dpmirt_dp_density</a></span><span class="op">(</span></span>
<span>  <span class="va">fit</span>,</span>
<span>  grid               <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/seq.html" class="external-link">seq</a></span><span class="op">(</span><span class="op">-</span><span class="fl">6</span>, <span class="fl">6</span>, length.out <span class="op">=</span> <span class="fl">500</span><span class="op">)</span>,</span>
<span>  credible_interval  <span class="op">=</span> <span class="fl">0.95</span>,</span>
<span>  apply_rescaling    <span class="op">=</span> <span class="cn">TRUE</span></span>
<span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Access the results</span></span>
<span><span class="va">dp_dens</span><span class="op">$</span><span class="va">grid</span>            <span class="co"># Evaluation points</span></span>
<span><span class="va">dp_dens</span><span class="op">$</span><span class="va">density_mean</span>    <span class="co"># Posterior mean density</span></span>
<span><span class="va">dp_dens</span><span class="op">$</span><span class="va">density_lower</span>   <span class="co"># 2.5th percentile (lower band)</span></span>
<span><span class="va">dp_dens</span><span class="op">$</span><span class="va">density_upper</span>   <span class="co"># 97.5th percentile (upper band)</span></span>
<span><span class="va">dp_dens</span><span class="op">$</span><span class="va">density_samples</span> <span class="co"># Full matrix: niter x n_grid</span></span></code></pre></div>
</div>
<div class="section level3">
<h3 id="visualization">Visualization<a class="anchor" aria-label="anchor" href="#visualization"></a>
</h3>
<div class="sourceCode" id="cb14"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Plot with credible band</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html" class="external-link">plot</a></span><span class="op">(</span><span class="va">dp_dens</span><span class="op">$</span><span class="va">grid</span>, <span class="va">dp_dens</span><span class="op">$</span><span class="va">density_mean</span>, type <span class="op">=</span> <span class="st">"l"</span>, lwd <span class="op">=</span> <span class="fl">2</span>,</span>
<span>     col <span class="op">=</span> <span class="va">pal</span><span class="op">$</span><span class="va">semiparametric</span>,</span>
<span>     xlab <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/expression.html" class="external-link">expression</a></span><span class="op">(</span><span class="va">theta</span><span class="op">)</span>, ylab <span class="op">=</span> <span class="st">"Density"</span>,</span>
<span>     main <span class="op">=</span> <span class="st">"DP Mixture Posterior Density"</span><span class="op">)</span></span>
<span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/polygon.html" class="external-link">polygon</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="va">dp_dens</span><span class="op">$</span><span class="va">grid</span>, <span class="fu"><a href="https://rdrr.io/r/base/rev.html" class="external-link">rev</a></span><span class="op">(</span><span class="va">dp_dens</span><span class="op">$</span><span class="va">grid</span><span class="op">)</span><span class="op">)</span>,</span>
<span>        <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="va">dp_dens</span><span class="op">$</span><span class="va">density_lower</span>, <span class="fu"><a href="https://rdrr.io/r/base/rev.html" class="external-link">rev</a></span><span class="op">(</span><span class="va">dp_dens</span><span class="op">$</span><span class="va">density_upper</span><span class="op">)</span><span class="op">)</span>,</span>
<span>        col <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/grDevices/adjustcolor.html" class="external-link">adjustcolor</a></span><span class="op">(</span><span class="va">pal</span><span class="op">$</span><span class="va">semiparametric</span>, alpha.f <span class="op">=</span> <span class="fl">0.2</span><span class="op">)</span>,</span>
<span>        border <span class="op">=</span> <span class="cn">NA</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Reference: N(0,1)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/curve.html" class="external-link">curve</a></span><span class="op">(</span><span class="va">dnorm</span>, add <span class="op">=</span> <span class="cn">TRUE</span>, lty <span class="op">=</span> <span class="fl">2</span>, col <span class="op">=</span> <span class="va">pal</span><span class="op">$</span><span class="va">reference</span>, lwd <span class="op">=</span> <span class="fl">1.5</span><span class="op">)</span></span>
<span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/legend.html" class="external-link">legend</a></span><span class="op">(</span><span class="st">"topright"</span>,</span>
<span>       legend <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"DP posterior mean"</span>, <span class="st">"95% credible band"</span>, <span class="st">"N(0,1)"</span><span class="op">)</span>,</span>
<span>       col <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="va">pal</span><span class="op">$</span><span class="va">semiparametric</span>, <span class="va">pal</span><span class="op">$</span><span class="va">semiparametric</span>, <span class="va">pal</span><span class="op">$</span><span class="va">reference</span><span class="op">)</span>,</span>
<span>       lwd <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">2</span>, <span class="cn">NA</span>, <span class="fl">1.5</span><span class="op">)</span>, lty <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">1</span>, <span class="cn">NA</span>, <span class="fl">2</span><span class="op">)</span>,</span>
<span>       fill <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="cn">NA</span>, <span class="fu"><a href="https://rdrr.io/r/grDevices/adjustcolor.html" class="external-link">adjustcolor</a></span><span class="op">(</span><span class="va">pal</span><span class="op">$</span><span class="va">semiparametric</span>, <span class="fl">0.2</span><span class="op">)</span>, <span class="cn">NA</span><span class="op">)</span>,</span>
<span>       border <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="cn">NA</span>, <span class="cn">NA</span>, <span class="cn">NA</span><span class="op">)</span>, bty <span class="op">=</span> <span class="st">"n"</span><span class="op">)</span></span></code></pre></div>
<blockquote>
<p><strong>Note on computation cost:</strong>
<code><a href="../reference/dpmirt_dp_density.html">dpmirt_dp_density()</a></code> internally rebuilds and recompiles a
NIMBLE model to call <code><a href="https://rdrr.io/pkg/nimble/man/getSamplesDPmeasure.html" class="external-link">getSamplesDPmeasure()</a></code>. This adds 30–60
seconds. The <code><a href="../reference/dpmirt.html">dpmirt()</a></code> function runs this automatically when
<code>compute_dp_density = TRUE</code> (the default for DPM models). If
you want to skip it, set <code>compute_dp_density = FALSE</code> and
call <code>dpmirt_dp_density(fit)</code> later.</p>
</blockquote>
</div>
</div>
<div class="section level2">
<h2 id="mcmc-pipeline-internals">MCMC Pipeline Internals<a class="anchor" aria-label="anchor" href="#mcmc-pipeline-internals"></a>
</h2>
<p>The following diagram shows the complete data flow from raw data to
the final <code>dpmirt_fit</code> object:</p>
<pre><code>data (N x I matrix)
  |
  v
dpmirt_spec()
  |-- code:       nimbleCode object
  |-- constants:  N, I, M, hyperparams
  |-- data:       list(y = ...)
  |-- inits:      smart init from k-means
  |-- monitors:   c("beta", "alpha", "zi", ...)
  |-- monitors2:  c("eta")
  v
dpmirt_compile()
  |-- nimbleModel()      --&gt; Rmodel
  |-- configureMCMC()    --&gt; add logProb_summer, centered sampler
  |-- buildMCMC()        --&gt; Rmcmc
  |-- compileNimble()    --&gt; Cmodel, Cmcmc
  v
dpmirt_sample()
  |-- runMCMC()          --&gt; samples (niter x params), samples2 (niter x N)
  v
dpmirt_rescale()
  |-- .rescale_rasch()   or .rescale_irt() or .rescale_si()
  |-- theta_samp, beta_samp, lambda_samp (all rescaled)
  v
dpmirt_fit object
  |-- theta_samp, beta_samp, ...
  |-- ess, waic, loglik_trace
  |-- cluster_info (DPM only)
  |-- dp_density (DPM only, optional)</code></pre>
<div class="section level3">
<h3 id="initial-values-k-means-strategy">Initial Values: K-means Strategy<a class="anchor" aria-label="anchor" href="#initial-values-k-means-strategy"></a>
</h3>
<p>DPMirt uses a k-means clustering strategy (following Paganin et al.)
for initializing DPM cluster assignments:</p>
<ol style="list-style-type: decimal">
<li>Compute standardized sum scores for each person.</li>
<li>Run k-means with
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>k</mi><mo>=</mo><mrow><mi mathvariant="normal">min</mi><mo>⁡</mo></mrow><mo stretchy="false" form="prefix">(</mo><mn>5</mn><mo>,</mo><mo stretchy="false" form="prefix">⌊</mo><mi>N</mi><mi>/</mi><mn>4</mn><mo stretchy="false" form="postfix">⌋</mo><mo stretchy="false" form="postfix">)</mo></mrow><annotation encoding="application/x-tex">k = \min(5, \lfloor N/4 \rfloor)</annotation></semantics></math>
clusters.</li>
<li>Use the cluster assignments as initial values for
<code>zi[1:N]</code>.</li>
</ol>
<p>This provides a reasonable starting point that reduces the burn-in
needed for the CRP to find a good configuration.</p>
</div>
<div class="section level3">
<h3 id="monitor-thinning">Monitor Thinning<a class="anchor" aria-label="anchor" href="#monitor-thinning"></a>
</h3>
<p>DPMirt supports differential thinning:</p>
<ul>
<li>
<strong>monitors</strong> (beta, lambda, alpha, zi, muTilde,
s2Tilde, logprob): Thinned at rate <code>thin</code> (default 1 = every
iteration).</li>
<li>
<strong>monitors2</strong> (eta/theta): Thinned at rate
<code>thin2</code> (default = <code>thin</code>).</li>
</ul>
<p>Since theta has
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mi>N</mi><annotation encoding="application/x-tex">N</annotation></semantics></math>
dimensions (one per person), it can dominate memory for large samples.
Setting <code>thin2 &gt; thin</code> reduces storage:</p>
<div class="sourceCode" id="cb16"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Thin theta more aggressively than item parameters</span></span>
<span><span class="va">fit</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/dpmirt.html">dpmirt</a></span><span class="op">(</span></span>
<span>  <span class="va">data</span>,</span>
<span>  model <span class="op">=</span> <span class="st">"rasch"</span>,</span>
<span>  prior <span class="op">=</span> <span class="st">"dpm"</span>,</span>
<span>  niter <span class="op">=</span> <span class="fl">20000</span>,</span>
<span>  thin  <span class="op">=</span> <span class="fl">1</span>,     <span class="co"># Keep every iteration for items</span></span>
<span>  thin2 <span class="op">=</span> <span class="fl">5</span>      <span class="co"># Keep every 5th iteration for theta</span></span>
<span><span class="op">)</span></span></code></pre></div>
</div>
</div>
<div class="section level2">
<h2 id="extending-dpmirt">Extending DPMirt<a class="anchor" aria-label="anchor" href="#extending-dpmirt"></a>
</h2>
<div class="section level3">
<h3 id="writing-a-custom-sampler">Writing a Custom Sampler<a class="anchor" aria-label="anchor" href="#writing-a-custom-sampler"></a>
</h3>
<p>To replace or supplement DPMirt’s default samplers:</p>
<div class="sourceCode" id="cb17"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Example: Block sampler for all item difficulties</span></span>
<span><span class="va">my_block_beta_config</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">conf</span>, <span class="va">model</span>, <span class="va">spec</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="va">I</span> <span class="op">&lt;-</span> <span class="va">spec</span><span class="op">$</span><span class="va">config</span><span class="op">$</span><span class="va">I</span></span>
<span></span>
<span>  <span class="co"># Remove individual beta samplers</span></span>
<span>  <span class="kw">for</span> <span class="op">(</span><span class="va">i</span> <span class="kw">in</span> <span class="fu"><a href="https://rdrr.io/r/base/seq.html" class="external-link">seq_len</a></span><span class="op">(</span><span class="va">I</span><span class="op">)</span><span class="op">)</span> <span class="op">{</span></span>
<span>    <span class="va">conf</span><span class="op">$</span><span class="fu">removeSamplers</span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/paste.html" class="external-link">paste0</a></span><span class="op">(</span><span class="st">"beta["</span>, <span class="va">i</span>, <span class="st">"]"</span><span class="op">)</span><span class="op">)</span></span>
<span>  <span class="op">}</span></span>
<span></span>
<span>  <span class="co"># Add a single block (AF_slice) sampler</span></span>
<span>  <span class="va">conf</span><span class="op">$</span><span class="fu">addSampler</span><span class="op">(</span></span>
<span>    target <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/paste.html" class="external-link">paste0</a></span><span class="op">(</span><span class="st">"beta[1:"</span>, <span class="va">I</span>, <span class="st">"]"</span><span class="op">)</span>,</span>
<span>    type   <span class="op">=</span> <span class="st">"AF_slice"</span></span>
<span>  <span class="op">)</span></span>
<span></span>
<span>  <span class="va">conf</span></span>
<span><span class="op">}</span></span>
<span></span>
<span><span class="va">compiled</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/dpmirt_compile.html">dpmirt_compile</a></span><span class="op">(</span><span class="va">spec</span>, sampler_config <span class="op">=</span> <span class="va">my_block_beta_config</span><span class="op">)</span></span></code></pre></div>
</div>
<div class="section level3">
<h3 id="adding-a-new-model">Adding a New Model<a class="anchor" aria-label="anchor" href="#adding-a-new-model"></a>
</h3>
<p>To add a new model type (e.g., a multidimensional IRT model), you
would:</p>
<ol style="list-style-type: decimal">
<li>Add a new code builder function in <code>R/model_spec.R</code>
(e.g., <code>.build_mirt_code()</code>).</li>
<li>Register it in the <code>.build_nimble_code()</code>
dispatcher.</li>
<li>Update <code>.generate_inits()</code> for the new parameter
structure.</li>
<li>Update <code>.setup_monitors()</code> for new parameters.</li>
<li>Add rescaling logic in <code>R/rescale.R</code> if needed.</li>
</ol>
</div>
<div class="section level3">
<h3 id="extracting-raw-nimble-objects">Extracting Raw NIMBLE Objects<a class="anchor" aria-label="anchor" href="#extracting-raw-nimble-objects"></a>
</h3>
<p>For maximum flexibility, you can extract the underlying NIMBLE
objects from a <code>dpmirt_compiled</code> object:</p>
<div class="sourceCode" id="cb18"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Get the compiled model</span></span>
<span><span class="va">Cmodel</span> <span class="op">&lt;-</span> <span class="va">compiled</span><span class="op">$</span><span class="va">Cmodel</span></span>
<span></span>
<span><span class="co"># Query model structure</span></span>
<span><span class="va">Cmodel</span><span class="op">$</span><span class="fu">getNodeNames</span><span class="op">(</span><span class="op">)</span></span>
<span><span class="va">Cmodel</span><span class="op">$</span><span class="fu">getDependencies</span><span class="op">(</span><span class="st">"beta[1]"</span><span class="op">)</span></span>
<span><span class="va">Cmodel</span><span class="op">$</span><span class="fu">getLogProb</span><span class="op">(</span><span class="st">"beta"</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Get the compiled MCMC</span></span>
<span><span class="va">Cmcmc</span> <span class="op">&lt;-</span> <span class="va">compiled</span><span class="op">$</span><span class="va">Cmcmc</span></span>
<span></span>
<span><span class="co"># Run MCMC manually</span></span>
<span><span class="va">Cmcmc</span><span class="op">$</span><span class="fu">run</span><span class="op">(</span><span class="fl">5000</span>, reset <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Extract samples directly</span></span>
<span><span class="va">samples</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/matrix.html" class="external-link">as.matrix</a></span><span class="op">(</span><span class="va">Cmcmc</span><span class="op">$</span><span class="va">mvSamples</span><span class="op">)</span></span>
<span><span class="va">samples2</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/matrix.html" class="external-link">as.matrix</a></span><span class="op">(</span><span class="va">Cmcmc</span><span class="op">$</span><span class="va">mvSamples2</span><span class="op">)</span></span></code></pre></div>
</div>
</div>
<div class="section level2">
<h2 id="troubleshooting">Troubleshooting<a class="anchor" aria-label="anchor" href="#troubleshooting"></a>
</h2>
<div class="section level3">
<h3 id="common-issues">Common Issues<a class="anchor" aria-label="anchor" href="#common-issues"></a>
</h3>
<table class="table">
<colgroup>
<col width="27%">
<col width="42%">
<col width="30%">
</colgroup>
<thead><tr class="header">
<th align="left">Symptom</th>
<th align="left">Likely Cause</th>
<th align="left">Solution</th>
</tr></thead>
<tbody>
<tr class="odd">
<td align="left">“Compiled model is no longer valid”</td>
<td align="left">Serialized/loaded compiled object</td>
<td align="left">Recompile from spec</td>
</tr>
<tr class="even">
<td align="left">Very slow compilation (&gt; 5 min)</td>
<td align="left">Large N or I</td>
<td align="left">Expected; reduce M for DPM</td>
</tr>
<tr class="odd">
<td align="left">Poor mixing for alpha</td>
<td align="left">Tight Gamma prior</td>
<td align="left">Use wider prior or DP-diffuse</td>
</tr>
<tr class="even">
<td align="left">All persons in one cluster</td>
<td align="left">alpha too small</td>
<td align="left">Increase mu_K or use “low” confidence</td>
</tr>
<tr class="odd">
<td align="left">WAIC computation failed</td>
<td align="left">NIMBLE version mismatch</td>
<td align="left">Update nimble; use compute_waic=FALSE</td>
</tr>
</tbody>
</table>
</div>
<div class="section level3">
<h3 id="checking-sampler-configuration">Checking Sampler Configuration<a class="anchor" aria-label="anchor" href="#checking-sampler-configuration"></a>
</h3>
<div class="sourceCode" id="cb19"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># After compilation, inspect what samplers are assigned</span></span>
<span><span class="va">compiled</span><span class="op">$</span><span class="va">mcmc_conf</span><span class="op">$</span><span class="fu">printSamplers</span><span class="op">(</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Count samplers by type</span></span>
<span><span class="va">sampler_types</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/lapply.html" class="external-link">sapply</a></span><span class="op">(</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/seq.html" class="external-link">seq_len</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/length.html" class="external-link">length</a></span><span class="op">(</span><span class="va">compiled</span><span class="op">$</span><span class="va">mcmc_conf</span><span class="op">$</span><span class="fu">getSamplers</span><span class="op">(</span><span class="op">)</span><span class="op">)</span><span class="op">)</span>,</span>
<span>  <span class="kw">function</span><span class="op">(</span><span class="va">i</span><span class="op">)</span> <span class="va">compiled</span><span class="op">$</span><span class="va">mcmc_conf</span><span class="op">$</span><span class="fu">getSamplers</span><span class="op">(</span><span class="op">)</span><span class="op">[[</span><span class="va">i</span><span class="op">]</span><span class="op">]</span><span class="op">$</span><span class="va">name</span></span>
<span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/table.html" class="external-link">table</a></span><span class="op">(</span><span class="va">sampler_types</span><span class="op">)</span></span></code></pre></div>
</div>
</div>
<div class="section level2">
<h2 id="whats-next">What’s Next?<a class="anchor" aria-label="anchor" href="#whats-next"></a>
</h2>
<table class="table">
<thead><tr class="header">
<th align="left">Vignette</th>
<th align="left">Why read it</th>
</tr></thead>
<tbody>
<tr class="odd">
<td align="left"><em>Quick Start</em></td>
<td align="left">End-to-end pipeline without worrying about
internals</td>
</tr>
<tr class="even">
<td align="left"><em>Prior Elicitation</em></td>
<td align="left">Principled
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mi>α</mi><annotation encoding="application/x-tex">\alpha</annotation></semantics></math>
choice via DPprior</td>
</tr>
<tr class="odd">
<td align="left"><em>Simulation Study</em></td>
<td align="left">Full factorial comparison of methods and priors</td>
</tr>
</tbody>
</table>
</div>
<div class="section level2">
<h2 id="references">References<a class="anchor" aria-label="anchor" href="#references"></a>
</h2>
<p>de Valpine, P., Turek, D., Paciorek, C. J., Anderson-Bergman, C.,
Lang, D. T., &amp; Bodik, R. (2017). Programming with models: Writing
statistical algorithms for general model structures with NIMBLE.
<em>Journal of Computational and Graphical Statistics</em>, 26(2),
403–413.</p>
<p>Paganin, S., Paciorek, C. J., Wehrhahn, C., Rodríguez, A.,
Rabe-Hesketh, S., &amp; de Valpine, P. (2023). Computational strategies
and estimation performance with Bayesian semiparametric item response
theory models. <em>Journal of Educational and Behavioral
Statistics</em>, 48(2), 147–188. <a href="https://doi.org/10.3102/10769986221136105" class="external-link uri">https://doi.org/10.3102/10769986221136105</a></p>
<p>NIMBLE Development Team. (2024). NIMBLE: MCMC, particle filtering,
and programmable hierarchical modeling. R package version 1.2.1. <a href="https://r-nimble.org" class="external-link uri">https://r-nimble.org</a></p>
</div>
  </main><aside class="col-md-3"><nav id="toc" aria-label="Table of contents"><h2>On this page</h2>
    </nav></aside>
</div>



    <footer><div class="pkgdown-footer-left">
  <p>Developed by <a href="https://github.com/joonho112" class="external-link">JoonHo Lee</a>.</p>
</div>

<div class="pkgdown-footer-right">
  <p>Site built with <a href="https://pkgdown.r-lib.org/" class="external-link">pkgdown</a> 2.2.0.</p>
</div>

    </footer>
</div>





  </body>
</html>
